# GitHub Secrets Terraform Module

This module manages GitHub Actions secrets for the MLOps project, automatically configuring secrets from AWS infrastructure outputs.

## Prerequisites

1. **GitHub PAT**: Generate a Personal Access Token
   ```bash
   ./github_pat_script.sh -o <your-github-org> -r try_ops
   ```

2. **AWS Infrastructure**: Deploy main infrastructure first
   ```bash
   cd ../
   terraform apply
   ```

## Usage

1. **Create tfvars file** (or use the one generated by `github_pat_script.sh`):
   ```hcl
   github_personal_access_token = "ghp_xxxxxxxxxxxx"
   github_owner                 = "your-github-username"
   github_repo                  = "try_ops"
   
   # These come from AWS infrastructure outputs
   aws_role_arn                 = "arn:aws:iam::123456789012:role/..."
   ecr_api_repository_url       = "123456789012.dkr.ecr.us-east-1.amazonaws.com/sam-mlops-production-api"
   ecr_training_repository_url  = "123456789012.dkr.ecr.us-east-1.amazonaws.com/sam-mlops-production-training"
   aws_region                   = "us-east-1"
   models_bucket_name           = "sam-mlops-production-models-123456789012"
   ```

2. **Initialize and apply**:
   ```bash
   terraform init
   terraform plan -var-file=github_secrets.tfvars
   terraform apply -var-file=github_secrets.tfvars
   ```

## Secrets Created

The following secrets will be created in your GitHub repository:

- `AWS_ROLE_ARN` - IAM role for OIDC authentication
- `ECR_API_REPOSITORY_URL` - API container registry URL
- `ECR_TRAINING_REPOSITORY_URL` - Training container registry URL
- `AWS_REGION` - AWS region for deployments
- `MODELS_BUCKET_NAME` - S3 bucket for model artifacts

## Variables Created

Non-sensitive configuration variables:

- `AWS_REGION` - AWS region
- `ENVIRONMENT` - Deployment environment (production)
- `DOCKER_BUILDKIT` - Enable Docker BuildKit

## Automated Workflow

For a streamlined setup, get AWS outputs and pass them to this module:

```bash
# From parent infra directory
cd ../
terraform output -json > outputs.json

# Parse and apply
cd github_infra
terraform apply \
  -var="github_owner=$(jq -r '.github_owner.value' ../outputs.json)" \
  -var="aws_role_arn=$(jq -r '.github_actions_role_arn.value' ../outputs.json)" \
  -var="ecr_api_repository_url=$(jq -r '.ecr_api_repository_url.value' ../outputs.json)" \
  -var="ecr_training_repository_url=$(jq -r '.ecr_training_repository_url.value' ../outputs.json)" \
  -var="models_bucket_name=$(jq -r '.models_bucket_name.value' ../outputs.json)" \
  -var-file=github_secrets.tfvars
```

## Security

- GitHub PAT is stored locally in `.github_pat_store` (gitignored)
- PAT is marked as sensitive in Terraform
- Secrets are encrypted by GitHub
- Use principle of least privilege for PAT permissions
